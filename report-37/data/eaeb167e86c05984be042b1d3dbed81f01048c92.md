# Test info

- Name: TC-14 Verificar transferencia recibida (Enviada por API)
- Location: /home/runner/work/taller-playwright-atenea/taller-playwright-atenea/tests/transacciones.spec.ts:41:1

# Error details

```
Error: La API para transferir dinero fall贸: 400

expect(received).toBeTruthy()

Received: false
    at /home/runner/work/taller-playwright-atenea/taller-playwright-atenea/tests/transacciones.spec.ts:87:120
```

# Page snapshot

```yaml
- banner:
  - link "ATENEA BANK":
    - /url: /
    - heading "ATENEA BANK" [level=6]
  - button "Cerrar sesi贸n"
- heading "Tablero Principal" [level=4]
- heading "Saldo total" [level=6]
- heading "$0.00" [level=3]
- text: +
- paragraph: Agregar cuenta
- button "Eliminar"
- button "Agregar fondos"
- button "Enviar"
- heading "Lista de transacciones" [level=5]
```

# Test source

```ts
   1 | import { test, expect } from '@playwright/test';
   2 | import { DashboardPage } from '../pages/dashboardPage';
   3 | import { ModalEnviarTransferencia } from '../pages/modalEnviarTransferencia';
   4 | import TestData from '../data/testData.json';
   5 | import fs from 'fs/promises';
   6 |
   7 | let dashboardPage: DashboardPage;
   8 | let modalEnviarTransferencia: ModalEnviarTransferencia;
   9 |
   10 | const testUsuarioEnvia = test.extend({
   11 |     storageState: require.resolve('../playwright/.auth/usuarioEnvia.json')
   12 | })
   13 |
   14 | const testUsuarioRecibe = test.extend({
   15 |     storageState: require.resolve('../playwright/.auth/usuarioRecibe.json')
   16 | })
   17 |
   18 | test.beforeEach(async ({ page }) => {
   19 |     dashboardPage = new DashboardPage(page);
   20 |     modalEnviarTransferencia = new ModalEnviarTransferencia(page);
   21 |     await dashboardPage.visitarPaginaDashboard();
   22 | })
   23 |
   24 | testUsuarioEnvia('TC-12 Verificar transacci贸n exitosa', async ({ page }) => {
   25 |     testUsuarioEnvia.info().annotations.push({
   26 |         type: 'Informacion de usuario que recibe',
   27 |         description: TestData.usuarioValido.email
   28 |     });
   29 |     await expect(dashboardPage.dashboardTitle).toBeVisible();
   30 |     await dashboardPage.botonEnviarDinero.click();
   31 |     await modalEnviarTransferencia.completarYHacerClickBotonEnviar(TestData.usuarioValido.email, '100');
   32 |     await expect(page.getByText('Transferencia enviada a ' + TestData.usuarioValido.email)).toBeVisible();
   33 | })
   34 |
   35 | testUsuarioRecibe('TC-13 Verificar que usuario reciba la transferencia', async ({ page }) => {
   36 |     await expect(dashboardPage.dashboardTitle).toBeVisible();
   37 |     await expect(page.getByText('Transferencia de email').first()).toBeVisible();
   38 | })
   39 |
   40 | // Test unificado que env铆a dinero por API y verifica en la UI.
   41 | testUsuarioRecibe('TC-14 Verificar transferencia recibida (Enviada por API)', async ({ page, request }) => {
   42 |     // #1 Preparacion para lectura de datos y TOKEN del remitente.
   43 |
   44 |     // leemos el archivo de datos del usuario que envia para obtener su email.
   45 |     const usuarioEnviaData = require.resolve('../playwright/.auth/usuarioEnvia.data.json');
   46 |     const usuarioEnviaContenidoData = await fs.readFile(usuarioEnviaData, 'utf-8');
   47 |     const datosDeUsuarioEnvia = JSON.parse(usuarioEnviaContenidoData);
   48 |     const emailDeUsuarioEnvia = datosDeUsuarioEnvia.email;
   49 |     expect(emailDeUsuarioEnvia, 'El email del usuario que envia no se leyo correctamente desde el archivo').toBeDefined();
   50 |
   51 |     // leemos el archivo de autenticacion del remitente para obtener su JWT.
   52 |     const usuarioEnviaAuth = require.resolve('../playwright/.auth/usuarioEnvia.json');
   53 |     const usuarioEnviaContenidoAuth = await fs.readFile(usuarioEnviaAuth, 'utf-8');
   54 |     const datosDeUsuarioEnviaAuth = JSON.parse(usuarioEnviaContenidoAuth);
   55 |
   56 |     const jwtDeUsuarioEnvia = datosDeUsuarioEnviaAuth.origins[0]?.localStorage.find(item => item.name === 'jwt');
   57 |     expect(jwtDeUsuarioEnvia, 'El JWT del usuario que envia no se leyo correctamente desde el archivo').toBeDefined();
   58 |     const jwt = jwtDeUsuarioEnvia.value;
   59 |
   60 |     // #2 Accion: Obtener Cuenta y Enviar Transferencia Via API
   61 |
   62 |     // Primero, obtenemos la cuenta del remitente para saver el ID de origen.
   63 |     const respuestaDeCuentas = await request.get('http://localhost:6007/api/accounts', {
   64 |         headers: {
   65 |             'Authorization': `Bearer ${jwt}`
   66 |         }
   67 |     });
   68 |     expect(respuestaDeCuentas.ok(), `La API para obtener cuentas fall贸: ${respuestaDeCuentas.status()}`).toBeTruthy();
   69 |     const cuentas = await respuestaDeCuentas.json();
   70 |     expect(cuentas.length, 'No se encontraron cuentas para el usuario').toBeGreaterThan(0);
   71 |     const idDeCuentaOrigen = cuentas[0]._id; // Tomamos el valor de ID de la primera cuenta
   72 |
   73 |     const montoAleatorio = Math.floor(Math.random() * 100) + 1; // Monto aleatorio entre 1 y 100.
   74 |     console.log(`Enviando transferencia de $${montoAleatorio} desde la cuenta ${idDeCuentaOrigen} a ${TestData.usuarioValido.email}`);
   75 |
   76 |     // Ahora con todos los datos, podemos enviar la transferencia de dinero de 1 cuenta a la otra.
   77 |     const respuestaDeTransferencia = await request.post('http://localhost:6007/api/transactions/transfer', {
   78 |         headers: {
   79 |             'Authorization': `Bearer ${jwt}`
   80 |         },
   81 |         data: {
   82 |             fromAccountId: idDeCuentaOrigen,
   83 |             toEmail: TestData.usuarioValido.email, // Destinatario Fijo.
   84 |             amount: montoAleatorio
   85 |         }
   86 |     });
>  87 |     expect(respuestaDeTransferencia.ok(), `La API para transferir dinero fall贸: ${respuestaDeTransferencia.status()}`).toBeTruthy();
      |                                                                                                                        ^ Error: La API para transferir dinero fall贸: 400
   88 |
   89 |     // #3 Verificacion: Comprobar que el monto llego al destinatario por UI
   90 |
   91 |     await page.reload(); // Recargamos la pagina para que se actualicen los datos.
   92 |     await page.waitForLoadState('networkidle');
   93 |     await expect(dashboardPage.dashboardTitle).toBeVisible();
   94 |
   95 |     // Verificamos que se muestre el mail del remitente en la fila, en el primer lugar.
   96 |     await expect(dashboardPage.elementosListaTransferencia.first()).toContainText(emailDeUsuarioEnvia);
   97 |
   98 |     // Verificamos que se muestre el monto correto.
   99 |     // Usamos una expresion regular para buscar el numero (ej. 5.00)
  100 |     const montoRegex = new RegExp(String(montoAleatorio.toFixed(2)));
  101 |     await expect(dashboardPage.elementosListaMontoTransferencia.first()).toContainText(montoRegex);
  102 | })
```

# Local changes

```diff
diff --git a/.github/workflows/test.yml b/.github/workflows/test.yml
new file mode 100644
index 0000000..84cf086
--- /dev/null
+++ b/.github/workflows/test.yml
@@ -0,0 +1,102 @@
+name: CI - Clonando App y Ejecutando Tests
+
+on:
+  push:
+    branches: [main]
+  pull_request:
+    branches: [main]
+
+jobs:
+  test:
+    runs-on: ubuntu-latest
+
+    services:
+      mongo:
+        image: mongo:6.0
+        ports:
+          - 27017:27017
+
+    env:
+      MONGO_URI: ${{ secrets.MONGO_URI }}
+      JWT_SECRET: ${{ secrets.JWT_SECRET }}
+      PORT: 6007
+      VITE_API_BASE: http://localhost:6007/api
+
+    steps:
+      - name: Checkout repo actual (con el workflow)
+        uses: actions/checkout@v3
+
+      - name: Clonar repo Athena Redux Bank
+        run: |
+          git clone https://github.com/Atenea-Conocimientos/redux-athena-bank.git app
+      - name: Crear archivo .env para backend
+        run: |
+          echo "MONGO_URI=${{ env.MONGO_URI }}" >> app/backend/.env
+          echo "JWT_SECRET=${{ env.JWT_SECRET }}" >> app/backend/.env
+          echo "PORT=${{ env.PORT }}" >> app/backend/.env
+      - name: Instalar dependencias backend
+        run: |
+          cd app/backend
+          npm install
+      - name: Levantar backend
+        run: |
+          cd app/backend
+          npm run dev > backend.log 2>&1 &
+        env:
+          MONGO_URI: ${{ env.MONGO_URI }}
+          JWT_SECRET: ${{ env.JWT_SECRET }}
+          PORT: ${{ env.PORT }}
+
+      - name: Instalar wait-on
+        run: npm install -g wait-on
+
+      - name: Esperar backend
+        run: wait-on tcp:6007
+
+      - name: Instalar dependencias frontend
+        run: |
+          cd app/frontend
+          npm install
+      - name: Levantar frontend
+        run: |
+          cd app/frontend
+          npm run dev > frontend.log 2>&1 &
+        env:
+          VITE_API_BASE: ${{ env.VITE_API_BASE }}
+
+      - name: Esperar frontend
+        run: wait-on http://localhost:3000
+
+      - name: Instalar y correr tests (proyectos setup + chromium)
+        run: |
+          npm install
+          npx playwright install
+          npx playwright test --reporter=html
+      - name: Guardar reportes como artifacts
+        if: always()
+        uses: actions/upload-artifact@v4
+        with:
+          name: playwright-report
+          path: ./playwright-report
+
+      - name: Deploy Playwright report to GitHub Pages
+        if: always()
+        run: |
+          git config --global user.name "github-actions[bot]"
+          git config --global user.email "github-actions[bot]@users.noreply.github.com"
+          # Clonar gh-pages branch en carpeta temporal
+          cd $RUNNER_TEMP
+          git clone --depth=1 --branch=gh-pages https://x-access-token:${{ secrets.GH_PAGES_PAT }}@github.com/${{ github.repository }} gh-pages
+          cd gh-pages
+          # Limpiar contenido viejo
+          rm -rf ./*
+          # Copiar nuevo contenido del reporte
+          mkdir -p report-${GITHUB_RUN_NUMBER}
+          cp -r $GITHUB_WORKSPACE/playwright-report/* ./report-${GITHUB_RUN_NUMBER}
+          # Commit y push
+          git add .
+          git commit -m " Reporte Playwright - Build $GITHUB_RUN_NUMBER"
+          git push origin gh-pages
+      - name: Imprimir link del reporte en consola
+        run: |
+            echo " Reporte disponible en: https://${{ github.repository_owner }}.github.io/${{ github.event.repository.name }}/report-${{ github.run_number }}/"
diff --git a/playwright.config.ts b/playwright.config.ts
index e87c6b9..efb17eb 100644
--- a/playwright.config.ts
+++ b/playwright.config.ts
@@ -18,9 +18,9 @@ export default defineConfig({
   /* Fail the build on CI if you accidentally left test.only in the source code. */
   forbidOnly: !!process.env.CI,
   /* Retry on CI only */
-  retries: process.env.CI ? 2 : 0,
+  retries: process.env.CI ? 2 : 1,
   /* Opt out of parallel tests on CI. */
-  workers: process.env.CI ? 1 : undefined,
+  workers: process.env.CI ? 3 : 2,
   /* Reporter to use. See https://playwright.dev/docs/test-reporters */
   reporter: 'html',
   /* Shared settings for all the projects below. See https://playwright.dev/docs/api/class-testoptions. */
diff --git a/tests/registro.setup.ts b/tests/registro.setup.ts
index 9a47468..076d85b 100644
--- a/tests/registro.setup.ts
+++ b/tests/registro.setup.ts
@@ -37,8 +37,9 @@ setup('Generar usuario que env铆a dinero', async ({ page, request }) => {
     await page.context().storageState({ path: usuarioEnviaAuthFile });
 })
 
-setup('Loguearse con usuario que recibe dinero', async ({ page }) => {
-    await loginPage.completarYHacerClickBotonLogin(TestData.usuarioValido);
+setup('Crear, Loguearse con usuario que recibe dinero', async ({ page, request }) => {
+    const nuevoUsuario = await BackendUtils.crearUsuarioPorAPI(request, TestData.usuarioValido, false);
+    await loginPage.completarYHacerClickBotonLogin(nuevoUsuario);
     await expect(dashboardPage.dashboardTitle).toBeVisible();
     await page.context().storageState({ path: usuarioRecibeAuthFile })
 })
diff --git a/utils/backendUtils.ts b/utils/backendUtils.ts
index 7e5036b..b7f3164 100644
--- a/utils/backendUtils.ts
+++ b/utils/backendUtils.ts
@@ -2,8 +2,15 @@ import { APIRequestContext, expect } from '@playwright/test';
 
 export class BackendUtils {
 
-  static async crearUsuarioPorAPI(request: APIRequestContext, usuario: any) {
-    const email = (usuario.email.split('@')[0]) + Date.now().toString() + '@' + usuario.email.split('@')[1];
+  static async crearUsuarioPorAPI(request: APIRequestContext, usuario: any, esNuevo: boolean = true) {
+    let email: string;
+
+    if (esNuevo) {
+      email = (usuario.email.split('@')[0]) + Date.now().toString() + '@' + usuario.email.split('@')[1];
+    } else {
+      email = usuario.email;
+    }
+
     const response = await request.post('http://localhost:6007/api/auth/signup', {
       headers: {
         'Accept': 'application/vnd.github.v3+json',
```